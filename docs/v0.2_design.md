# LCEngine v0.2 Design

## Goals & Scope

- 升级向量检索为 FAISS，支持 metadata（主题/来源/时间/用户）并保留 SQLite+numpy 作为简易 fallback。
- 引入长期记忆（笔记/错题）存储与“保存”入口，记忆与普通文档统一检索。
- UI 增加外网搜索开关（默认 ON）及状态提示；v0.2 仅记录状态，不触发网络，供 v0.3 搜索 Agent 接入。
- 提供最小可跑的评测脚本 `evaluate.py`，输出 Hit@k / RAGAS / P95 延迟 / 成本，结果落盘 `data/eval_runs/`.
- 补齐文档记录链路：DEVLOG、experiments 记录配置与指标。

## Non-goals

- 不引入完整搜索 Agent 或爬取逻辑（规划到 v0.3）。
- 不上线多路由/Multi-Query/重排（规划到 v0.4）。
- 不实现学习模式模板/练习生成（规划到 v0.5）。

## Architecture Changes

### Vector Store

- 结构：新增 `app/vector_store/faiss_store.py`，封装 `FaissVectorStore`，接口与现有 `SQLiteVectorStore` 对齐：`add_chunks`, `search`, `load`, `save`.
- Metadata：内存中维持 `DocumentChunk`，`metadata` 至少包含 `source`, `chunk_id`, `start_char`, `end_char`, `length`, `topic`, `created_at`, `user`, `doc_type` (`document` | `note` | `mistake`), `labels`。
- 持久化：
  - 向量：FAISS 主索引 `data/faiss/index.faiss`，管理 vector id。
  - 元数据：统一放 SQLite（复用/扩展当前 `documents`/`chunks` 表，添加 doc_type/topic/created_at/user/labels 字段并建索引），存储 FAISS vector id 以便 join。labels 采用关联表 `labels(chunk_id, label)`。
- 适配层：`app/vector_store/__init__.py` 暴露工厂 `get_vector_store(store: Literal["faiss","sqlite"])`.
- 配置：`VECTOR_BACKEND` env/Config，默认 `"faiss"`；保留 `VECTOR_STORE_DB_PATH`/`VECTOR_STORE_DIR` 向后兼容。

### Memory & Knowledge Objects

- 统一数据模型：`DocumentChunk` 增加 `doc_type` 与 `labels`（list[str]），便于过滤/加权。
- 长期记忆存储：
  - 新建表/文件 `memory_entries`（最终字段）：`id`, `type` (`note`|`mistake`), `title`, `question_raw`, `answer_raw`, `refined_question`, `refined_answer`, `explanation`, `tags`, `topic`, `source`, `user`, `model_version`, `refined_by_model` (bool), `created_at`.
  - 写入路径：来自 UI 的“保存为笔记/错题”按钮 → 生成一个虚拟文档并 chunk/embed → 写入 vector store + metadata 标记。
  - 字段策略：始终保留原始问/答；可选开启 LLM 精炼，生成 refined_question/refined_answer/explanation，失败时回退原始内容；标注 `refined_by_model` 与 `model_version`。
  - 检索时优先：查询阶段可按 `doc_type` 调整重排权重（简单版本：笔记/错题加权 +0.05，开放问题见后）。
- Conversation history 仍在内存，v0.2 不做持久化。

### UI / UX

- Sidebar：新增“外网搜索”开关（默认 ON）、状态提示（本地索引条数、FAISS 是否可用）。
- 聊天区：
  - 回答区域添加“保存为笔记”“标记为错题”按钮，成功后弹 toast。
  - Debug 区展示 doc_type / topic / created_at。
- 视觉保持轻量；避免引入额外依赖。
- 外网搜索开关占位：仅记录 `st.session_state.external_search_enabled`（默认 True），UI 显示状态提示；当前不触发任何 Agent/网络调用，v0.3 接入搜索时复用该开关。

### Pipeline

- 初始化：`RAGPipeline` 通过工厂选择 `FaissVectorStore`（默认）。启动时如果 FAISS 索引不存在，自动创建并同步 SQLite 元数据。
- 处理文档：沿用 chunk → embed → add_chunks，metadata 增加 `doc_type="document"` 与 `created_at`.
- 查询：保持 standalone query。FAISS 按 L2/内积先取 raw_top_k（默认 `2 * top_k`，top_k 默认 5；均可配置，默认不暴露给 UI）。
- 记忆加权与重排：对 `doc_type` 为 `note`/`mistake` 的候选加 bias（默认 +0.05，可配置），score = sim + bias；若存在 note/mistake 可保证至少混入 1 条；重排后截断 top_k，记录加权前/后排名用于调试。
- 过滤：可选参数 `doc_types` / `topics` 前置过滤 metadata。
- Embedding 文本选择：若存在精炼版，默认用 refined_question/refined_answer 生成 embedding；否则用原始问/答；metadata 标记是否为精炼版本。

## Evaluation Plan (`evaluate.py`)

- 输入：`--dataset tests/data/evaluation_dataset.json`，`--k 5`，`--model <chat_model>`，`--vector-backend faiss`（默认使用当前配置的 CHAT_MODEL，可按可用模型替换）。
- 流程：加载评测集 → 对每条问题执行检索+生成 → 记录返回上下文、答案、延迟、token 成本。
- 指标：
  - Hit@k（是否命中理想答案所在文档，使用 source/简单双重匹配）。
  - RAGAS（默认启用，依赖随 v0.2 一起安装；如缺依赖则明确报错提示）：使用现有 chat/embedding 模型计算 faithfulness（防幻觉）、context precision/recall（检索相关性与覆盖）、answer relevancy/answer correctness（回答贴合问题与参考答案）。
  - P95 latency, average cost.
- 输出：`data/eval_runs/<timestamp>.json` 与 CSV 摘要；stdout 打印表格。
- 复用：提供 `--dry-run`（只检索不调用模型）、`--limit`（子集）方便 CI。

## Data Layout

- `data/faiss/index.faiss`：主索引文件（向量）。
- SQLite（默认 `data/vector_store.db`）：documents/chunks/memory_entries + labels 表，包含 metadata 与 FAISS vector id。
- `data/memory/`：长期记忆原文（可选，一份 JSONL 导出）。
- `data/eval_runs/`：评测结果落盘。
- 迁移提示：v0.2 建议重新 ingest；如有旧版 SQLite/numpy 数据，可删除 `data/vector_store.db` 与 `data/vectors/` 后再处理文档。

## Testing Plan

- 单测：新增 FAISS store 测试（创建、add/search、持久化 load/save）、metadata 过滤、记忆写入。
- 集成：上传文档 + 保存笔记 → 检索命中；评测脚本 dry-run。
- 性能：`pytest -m "slow"` 增加 10k chunk 构建与查询基线。

## Indexing Best Practices

- 字段类型：`doc_type TEXT CHECK(doc_type IN ('document','note','mistake'))`, `topic TEXT`, `created_at DATETIME DEFAULT CURRENT_TIMESTAMP`, `user TEXT`.
- labels 关联表：`labels(chunk_id INTEGER, label TEXT)`，索引 `idx_labels_label`（label）与可选 `idx_labels_chunk`（chunk_id）。
- 组合索引（按常用过滤组合设计）：
  - `idx_chunks_doc_type_topic` ON chunks(doc_type, topic) —— 支撑“仅笔记/错题 + topic”过滤。
  - `idx_chunks_doc_type_created_at` ON chunks(doc_type, created_at DESC) —— 支撑“最近的笔记/错题/文档”查询。
  - 保留现有 document/source 相关索引。

## PR 拆分建议

- PR1：向量库切换与数据层。新增 `FaissVectorStore`、工厂选择、FAISS+SQLite/labels 表结构与索引，配置兼容（`VECTOR_BACKEND`/路径），SQLite fallback 保持可用；迁移/重建提示；FAISS/metadata 单测。
- PR2：记忆与 UI 集成。`DocumentChunk` 扩展字段、`memory_entries` 写入与 labels、查询加权/过滤、UI 按钮（保存笔记/错题）、外网搜索开关与状态提示、调试信息；端到端集成测试覆盖“上传+保存+检索命中”。
- PR3：评测工具链。`evaluate.py`（Hit@k、RAGAS、P95/成本、dry-run/limit）、结果落盘布局、依赖声明，基线/慢测用例与 DEVLOG/文档更新。
